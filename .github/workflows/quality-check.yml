name: Documentation Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 9 AM UTC to check for documentation updates
    - cron: '0 9 * * *'

jobs:
  validate-documentation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Validate configuration files
      run: |
        python -c "import json; json.load(open('config.json'))"
        echo "✅ config.json is valid JSON"
        
    - name: Check markdown formatting
      uses: DavidAnson/markdownlint-action@v1
      with:
        files: '**/*.md'
        config: '.markdownlint.json'
        
    - name: Validate prompt examples
      run: |
        python -c "
        import re
        import os
        
        # Check for prompt rating templates in guides
        rating_pattern = r'Rate this prompt.*\(1-10\)'
        obsolescence_pattern = r'# Guidance Obsolescence|## .*Obsolescence'
        
        md_files = []
        for root, dirs, files in os.walk('.'):
            for file in files:
                if file.endswith('.md') and not file.startswith('README'):
                    md_files.append(os.path.join(root, file))
        
        issues = []
        for file_path in md_files:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            # Check for rating system
            if 'prompt' in file_path.lower() and not re.search(rating_pattern, content, re.IGNORECASE):
                issues.append(f'{file_path}: Missing prompt rating system')
                
            # Check for obsolescence tracking  
            if 'guide' in file_path.lower() and not re.search(obsolescence_pattern, content, re.IGNORECASE):
                issues.append(f'{file_path}: Missing obsolescence tracking section')
        
        if issues:
            print('❌ Documentation quality issues found:')
            for issue in issues:
                print(f'  - {issue}')
            exit(1)
        else:
            print('✅ All documentation meets quality standards')
        "
        
    - name: Test auto-updater (dry run)
      run: |
        # Test the updater without making actual API calls
        python -c "
        import sys
        sys.path.append('.')

        # Mock test of the updater system
        try:
            with open('doc_updater.py', 'r') as f:
                content = f.read()

            # Check for required classes and methods
            required_elements = [
                'class AIDocumentationUpdater',
                'def fetch_latest_info',
                'def analyze_changes',
                'def create_updated_document',
                'def run_daily_check',
                'def generate_review_request',
                'FeedbackCollector',
            ]

            missing = []
            for element in required_elements:
                if element not in content:
                    missing.append(element)

            if missing:
                print(f'❌ Missing required elements: {missing}')
                exit(1)
            else:
                print('✅ Auto-updater structure is valid')

        except Exception as e:
            print(f'❌ Error testing auto-updater: {e}')
            exit(1)
        "

    - name: Test feedback collector
      run: |
        python -c "
        import sys
        sys.path.append('.')

        try:
            with open('feedback_collector.py', 'r') as f:
                content = f.read()

            required_elements = [
                'class FeedbackCollector',
                'def add_feedback',
                'def get_feedback_summary',
                'def list_pending_reviews',
                'def interactive_review',
            ]

            missing = [e for e in required_elements if e not in content]
            if missing:
                print(f'❌ Missing elements in feedback_collector.py: {missing}')
                exit(1)
            else:
                print('✅ Feedback collector structure is valid')

        except Exception as e:
            print(f'❌ Error testing feedback collector: {e}')
            exit(1)
        "

    - name: Validate human review guide
      run: |
        if [ ! -f "HUMAN-REVIEW-GUIDE.md" ]; then
          echo "❌ HUMAN-REVIEW-GUIDE.md is missing"
          exit 1
        fi
        echo "✅ HUMAN-REVIEW-GUIDE.md is present"

    - name: Validate GitHub issue template for feedback
      run: |
        if [ ! -f ".github/ISSUE_TEMPLATE/doc-feedback.yml" ]; then
          echo "❌ doc-feedback.yml issue template is missing"
          exit 1
        fi
        echo "✅ doc-feedback.yml issue template is present"

  check-links:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check internal links
      run: |
        python -c "
        import re
        import os
        
        # Find all markdown files
        md_files = []
        for root, dirs, files in os.walk('.'):
            for file in files:
                if file.endswith('.md'):
                    md_files.append(os.path.join(root, file))
        
        # Extract all internal links
        link_pattern = r'\[([^\]]+)\]\(([^)]+)\)'
        broken_links = []
        
        for file_path in md_files:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            matches = re.findall(link_pattern, content)
            for text, link in matches:
                # Skip external links
                if link.startswith('http'):
                    continue
                
                # Skip anchor-only links (same-page section references)
                if link.startswith('#'):
                    continue
                
                # Strip anchor fragment before checking file existence
                link_file = link.split('#')[0]
                if not link_file:
                    continue
                    
                # Check if internal link exists
                link_path = os.path.normpath(os.path.join(os.path.dirname(file_path), link_file))
                if not os.path.exists(link_path):
                    broken_links.append(f'{file_path}: [{text}]({link})')
        
        if broken_links:
            print('❌ Broken internal links found:')
            for link in broken_links:
                print(f'  - {link}')
            exit(1)
        else:
            print('✅ All internal links are valid')
        "

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for exposed secrets
      run: |
        # Check for potential API keys or secrets in files
        if grep -r -i "sk-[a-zA-Z0-9]" . --exclude-dir=.git --exclude="*.yml" --exclude="*.yaml"; then
          echo "❌ Potential API key found in repository"
          exit 1
        fi
        
        if grep -r -i "bearer [a-zA-Z0-9]" . --exclude-dir=.git --exclude="*.yml" --exclude="*.yaml"; then
          echo "❌ Potential bearer token found in repository"  
          exit 1
        fi
        
        echo "✅ No exposed secrets detected"
        
    - name: Validate security documentation
      run: |
        if [ ! -f "SECURITY.md" ]; then
          echo "❌ SECURITY.md is missing"
          exit 1
        fi
        
        if [ ! -f "CONTRIBUTING.md" ]; then
          echo "❌ CONTRIBUTING.md is missing"
          exit 1
        fi
        
        echo "✅ Security documentation is present"
