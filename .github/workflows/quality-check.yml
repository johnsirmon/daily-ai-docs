name: Documentation Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 9 AM UTC to check for documentation updates
    - cron: '0 9 * * *'

jobs:
  validate-documentation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Validate configuration files
      run: |
        python -c "import json; json.load(open('config.json'))"
        echo "✅ config.json is valid JSON"
        
    - name: Check markdown formatting
      uses: DavidAnson/markdownlint-action@v1
      with:
        files: '**/*.md'
        config: '.markdownlint.json'
        
    - name: Test auto-updater (dry run)
      run: |
        # Test the updater without making actual API calls
        python -c "
        import sys
        sys.path.append('.')

        # Mock test of the updater system
        try:
            with open('doc_updater.py', 'r') as f:
                content = f.read()

            # Check for required classes and methods
            required_elements = [
                'class AIDocumentationUpdater',
                'def fetch_latest_info',
                'def analyze_changes',
                'def create_updated_document',
                'def run_daily_check',
                'def generate_review_request',
                'FeedbackCollector',
            ]

            missing = []
            for element in required_elements:
                if element not in content:
                    missing.append(element)

            if missing:
                print(f'❌ Missing required elements: {missing}')
                exit(1)
            else:
                print('✅ Auto-updater structure is valid')

        except Exception as e:
            print(f'❌ Error testing auto-updater: {e}')
            exit(1)
        "

    - name: Test feedback collector
      run: |
        python -c "
        import sys
        sys.path.append('.')

        try:
            with open('feedback_collector.py', 'r') as f:
                content = f.read()

            required_elements = [
                'class FeedbackCollector',
                'def add_feedback',
                'def get_feedback_summary',
                'def list_pending_reviews',
                'def interactive_review',
            ]

            missing = [e for e in required_elements if e not in content]
            if missing:
                print(f'❌ Missing elements in feedback_collector.py: {missing}')
                exit(1)
            else:
                print('✅ Feedback collector structure is valid')

        except Exception as e:
            print(f'❌ Error testing feedback collector: {e}')
            exit(1)
        "

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for exposed secrets
      run: |
        # Check for potential API keys or secrets in files
        if grep -r -i "sk-[a-zA-Z0-9]" . --exclude-dir=.git --exclude="*.yml" --exclude="*.yaml"; then
          echo "❌ Potential API key found in repository"
          exit 1
        fi
        
        if grep -r -i "bearer [a-zA-Z0-9]" . --exclude-dir=.git --exclude="*.yml" --exclude="*.yaml"; then
          echo "❌ Potential bearer token found in repository"  
          exit 1
        fi
        
        echo "✅ No exposed secrets detected"
